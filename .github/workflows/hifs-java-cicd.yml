name: Hifs Java CI/CD

on:
  push:
    branches: [main]
    paths:
      - "hifs_java/**"
  pull_request:
    branches: [main]
    paths:
      - "hifs_java/**"
  # æ‰‹åŠ¨è§¦å‘ï¼šä½ å¯ä»¥åœ¨ GitHub é¡µé¢ä¸Šæ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®æ¥è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

env:
  SOURCE_DIR: hifs_java
  DOCKER_DIR: hifs_java/docker
  DEPLOY_DIR: /opt/hifs # æœåŠ¡å™¨ç›®æ ‡ç›®å½•
  CONTAINER_NAME: jar-builder-${{ github.run_id }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # =====================================
      # é˜¶æ®µ1ï¼šæ„å»ºJARåˆ°æœ¬åœ°docker/appç›®å½•
      # =====================================
      - uses: actions/checkout@v4

      # æ·»åŠ  Maven ç¼“å­˜
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      - name: Generate JAR to App Dir
        run: |
          # æ¸…ç†å¯èƒ½æ®‹ç•™çš„æ—§å®¹å™¨
          docker rm -f $CONTAINER_NAME || true

          # æ„å»ºé•œåƒæå–JAR
          docker build -f $DOCKER_DIR/Dockerfile -t $CONTAINER_NAME $SOURCE_DIR

           # åˆ›å»ºå®¹å™¨ï¼ˆä¸éœ€è¦å¯åŠ¨ï¼‰
          docker create --name $CONTAINER_NAME $CONTAINER_NAME

          # å¤åˆ¶JARåˆ°æœ¬åœ°appç›®å½•
          mkdir -p $DOCKER_DIR/app
          docker cp $CONTAINER_NAME:/output/app/. $DOCKER_DIR/app/

          # éªŒè¯JARæ–‡ä»¶
          if ! ls $DOCKER_DIR/app/*.jar >/dev/null 2>&1; then
            echo "âŒ é”™è¯¯ï¼šJARæ–‡ä»¶æœªç”Ÿæˆï¼"
            echo "ğŸ“ æ„å»ºç›®å½•å†…å®¹ï¼š"
            ls -la $DOCKER_DIR/app/
            docker rm -f $CONTAINER_NAME
            exit 1
          fi

          # å¼ºåˆ¶æ¸…ç†å®¹å™¨
          docker rm -f $CONTAINER_NAME

      # =====================================
      # é˜¶æ®µ2ï¼šä¼ è¾“æ•´ä¸ªdockerç›®å½•åˆ°æœåŠ¡å™¨
      # =====================================
      - name: Transfer Full Docker Dir
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }} # æŒ‡å®š SSH ç«¯å£
          source: "$DOCKER_DIR/**" # ä¼ è¾“æ•´ä¸ªdockerç›®å½•
          target: "$DEPLOY_DIR/"
          strip_components:
            3 # è·¯å¾„è½¬æ¢ç¤ºä¾‹ï¼š
            # hifs_java/docker/file â†’ DEPLOY_DIR/file
            # hifs_java/docker/app/file.jar â†’ DEPLOY_DIR/app/file.jar
          overwrite: true

      # =====================================
      # é˜¶æ®µ3ï¼šè§¦å‘æœåŠ¡å™¨éƒ¨ç½²ï¼ˆä½¿ç”¨ç°æœ‰è„šæœ¬ï¼‰
      # =====================================
      - name: Execute Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }} # æŒ‡å®š SSH ç«¯å£
          script: |
            cd $DEPLOY_DIR
            chmod +x deploy.sh  # ç¡®ä¿å¯æ‰§è¡Œæƒé™
            ./deploy.sh prod
